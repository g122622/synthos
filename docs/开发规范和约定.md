# 开发规范和约定

## 【规范等级说明】

- `[MUST]`：必须满足的规范，不遵循将会被驳回
- `[SHOULD]`：强烈推荐，特殊情况下可例外，但需说明理由
- `[RECOMMEND]`：推荐遵循的最佳实践

## 【要求&约束】

**写代码前：**

1. `[SHOULD]` 请你先充分阅读和探索这个项目中的readme（根目录和各个子项目都有readme）、相关的文件（你还可以在网上查找上面涉及到的项目的文档，遇到问题了也可以随时联网查找），然后指出你还有哪些疑惑、我没描述清楚的地方，停下来等我回答。
2. `[SHOULD]` 务必尽可能复用项目中已有的基建，你可以在写代码前把common目录全看一遍，并确保写出来的代码和现有文件的编写风格一致
3. `[SHOULD]` 务必在写代码前参考同类文件（比如你想修改或新增某目录下的`AaaService.ts`，你需要先阅读同路径下已有的`BbbService.ts`。这样是为了确保代码风格和约定一致，与现有代码无缝集成
4. `[MUST]` 项目使用pnpm + monorepo管理依赖，严禁使用npm！若想新增依赖，你需要先修改子项目的package.json，然后再退回到整个monorepo大仓的根目录执行pnpm install。不要在子项目目录中执行pnpm install

**写代码时：**

1. `[MUST]` 本项目的monorepo结构要求子项目之间不能有任何的相互引用（子项目只能引用 `项目根目录/common` 下的代码；特别的是，webui-frontend子项目必须完全内聚，不允许引用`项目根目录/common`）；如果需要子项目之间相互调用，可以走tRPC
2. `[SHOULD]` 项目使用tsyringe进行依赖注入，若要使用common/services下的服务，必须通过DI框架进行获取。可参考`applications\ai-model\src\tasks\AISummarize.ts`的写法
3. `[RECOMMEND]` 涉及到迁移和重构类任务时，务必尽可能保留原代码中的注释（如果注释内容随着迁移已经过时或错误，则进行改写）
4. `[SHOULD]` 若要新增后端接口，务必使用 applications/webui-backend/src/schemas 来进行参数校验
5. `[RECOMMEND]` ConfigManagerService在冷启动时会对配置文件根据schema进行强校验，因此配置文件在运行时一定是完整的、正确的，不用担心某些字段不存在，因此不要写出类似下面代码：

    ```ts
    // NO!
    const interestScoreThreshold = config.report?.generation?.interestScoreThreshold ?? 0;
    // 直接写成下面的即可：
    const interestScoreThreshold = config.report.generation.interestScoreThreshold; // 不允许使用可选链和默认值
    ```

6. `[MUST]` 受编译工具链限制，对于涉及`index.ts`的引入，import的时候不允许省略`index`、不允许加上`.ts`后缀 例如正确写法是：`import { xxx } from "../contracts/report/index";` 而不是 `import { xxx } from "../contracts/report";`，此外也不能写成 `import { xxx } from "../contracts/report/index.ts";`
7. `[MUST]` 项目中所有number类型的时间表示统一使用标准UNIX毫秒级时间戳
8. `[SHOULD]` 错误处理规范：所有空指针操作（比如根据不存在的id查询对应的数据、删除不存在的id等）一律立即抛错，不要静默处理；如果该操作返回结果是数组，那么此时不必抛错，可以返回空数组
9. `[RECOMMEND]` 前端组件尽量不要超过400行左右，若发现其超过400行左右，则拆分成父组件+若干子组件，子组件放在父组件目录下的`components目录`

**写完代码后：**

1. `[MUST]` 请在代码修改完成后，检查对应的这些文件（如果有的话）是否要增加/删除相应内容：README（大仓根目录和子项目根目录都有readme）；package.json；文档（路径：根目录/docs）；单元测试（一般位于子项目根目录的test路径下）；集成测试（一般位于子项目根目录的test路径下）；mock（仅前端）
2. `[MUST]` 代码编写完成后先构建common，然后再在子项目根目录下执行 `npx tsc --noEmit 2>&1` 检查是否有语法错误；如果更改的文件涉及对应的测试文件，请运行测试文件
3. `[RECOMMEND]` 请在结束后记得清理掉你在调试过程中加的注释和日志输出（如果有的话）

## 【代码样式规范】

1. `[RECOMMEND]` 函数参数列表尽量不加默认参数
2. `[SHOULD]` 注释、日志输出、测试用例名称都使用中文
3. `[SHOULD]` 不允许省略类成员的访问修饰符（如private、public）；请在private方法命名加上下划线前缀，如`_doDeleteEmbedding`
4. `[SHOULD]` 由于正则表达式易出错且不易code-review，请避免使用正则
5. `[SHOULD]` 为类和类的方法编写jsdoc格式的注释
6. `[SHOULD]` if语句或循环语句后的代码块即使只有一行，也不许省略大括号
7. `[SHOULD]` 文件命名使用驼峰（大小驼峰的选取参考现有文件）；文件夹命名使用小写字母+连字符；类名和类型名使用大驼峰

## 【安全规范】

1. `[MUST]` 禁止在代码中直接写入密钥、密码、数据库地址、用户名、群聊信息等敏感信息，请使用配置文件（优先选用）or环境变量等其他方式将其注入到执行环境中
2. `[MUST]` 写代码前评估SQL注入、XSS、CSRF、RCE等安全风险
3. `[MUST]` 高敏感信息如密码禁止在前端直接明文展示

## 其他要求

后续与我对话请使用中文

请你先充分阅读和探索这个项目中的readme（根目录和各个子项目都有readme）、相关的文件（你还可以在网上查找上面涉及到的项目的文档，遇到问题了也可以随时联网查找），然后指出你还有哪些疑惑、我没描述清楚的地方，停下来等我回答！你先别写代码
