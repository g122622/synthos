# 前端开发指引（已按源码更新）

> 面向 WebUI 前端：以当前后端实现为准完成接入与页面开发。

## 1. 本地联调

- WebUI Backend 默认：`http://localhost:3002`
- 建议：前端开发服务器配置代理 `/api -> http://localhost:3002/api`，并把 `/health` 也代理过去。

## 2. 通用调用约定

### 2.1 请求

- POST 请求统一 JSON：`Content-Type: application/json`
- 时间戳统一毫秒（UNIX ms）。

### 2.2 响应与错误

- 大多数接口：`{ success: true, data }` / `{ success: false, message }`
- 配置接口有少量分支使用 `{ success: false, error }`；建议统一做：

```ts
const errMsg = resp.message ?? resp.error ?? "未知错误";
```

- 系统监控接口是例外：直接返回对象/数组，不包 `success`。

### 2.3 参数小坑

- `GET /api/chat-messages-by-group-id` 的 `timeStart/timeEnd` 来自 query string，后端会 `parseInt`，请传字符串数字。

## 3. 页面/模块与接口映射（建议）

### 3.1 群组与聊天记录浏览

- 群组列表/群详情：`GET /api/group-details`

- 聊天消息列表（按群 + 时间范围）：
  - `GET /api/chat-messages-by-group-id?groupId=...&timeStart=...&timeEnd=...`
  - 返回包含 raw 字段 + `sessionId` + `preProcessedContent`（若已预处理）。

- 会话选择（按群 + 时间范围拉取 sessionId）：
  - `POST /api/session-ids-by-group-ids-and-time-range`
  - 渲染会话的时间范围：`POST /api/session-time-durations`

- 消息趋势（当前 24h + 昨日 24h）：`POST /api/message-hourly-stats`

### 3.2 主题/摘要结果

- 获取单个 topic 摘要：`GET /api/ai-digest-result-by-topic-id?topicId=...`
- 按会话批量获取摘要：`POST /api/ai-digest-results-by-session-ids`
- 判断会话是否已摘要：`GET /api/is-session-summarized?sessionId=...`

### 3.3 话题状态（收藏/已读）

- 收藏/取消收藏：
  - `POST /api/topic/favorite/mark`
  - `POST /api/topic/favorite/remove`

- 批量查询收藏状态（列表渲染前置）：`POST /api/topic/favorite/status`

- 已读/取消已读：
  - `POST /api/topic/read/mark`
  - `POST /api/topic/read/unmark`

- 批量查询已读状态：`POST /api/topic/read/status`

### 3.4 兴趣度评分

- 批量获取 topic 兴趣度：`POST /api/interest-score-results`

### 3.5 搜索与 RAG 问答

- 语义搜索：`POST /api/search`
- RAG 问答：`POST /api/ask`（返回 `answer + references`）

#### 3.5.1 WebUI 侧问答历史（本地持久化）

如果需要问答历史在 WebUI 内可回看：

- 列表分页：`POST /api/rag/session/list`（limit/offset）
- 详情：`POST /api/rag/session/detail`
- 删除：`POST /api/rag/session/delete`
- 改标题：`POST /api/rag/session/update-title`
- 清空：`POST /api/rag/session/clear-all`

说明：会话创建不再由前端显式调用接口完成；WebUI-Backend 会在 tRPC `askStream` 流式结束后自动落库，并在 `done` chunk 中返回 `sessionId`。

### 3.6 日报中心

- 列表分页：`POST /api/reports`（page/pageSize，可选 type）
- 单条详情：`GET /api/report/:reportId`
- 最近日报：`POST /api/reports/recent`
- 按日期/时间范围：
  - `POST /api/reports/by-date`
  - `POST /api/reports/by-time-range`

- 已读状态：
  - `POST /api/report/read/mark`
  - `POST /api/report/read/unmark`
  - `POST /api/report/read/status`

- 运维/手动触发：
  - 生成：`POST /api/reports/generate`
  - 邮件发送：`POST /api/report/send-email`

### 3.7 系统监控

- 最新：`GET /api/system/monitor/latest`（建议 1s~3s 轮询）
- 历史：`GET /api/system/monitor/history`（用于折线图）

注意：该模块接口返回 **不含** `success` 包裹。

### 3.8 Agent 对话

- 发起问答：`POST /api/agent/ask`
- 会话列表分页：`POST /api/agent/conversations`（beforeUpdatedAt + limit）
- 会话消息分页：`POST /api/agent/conversations/:id/messages`（beforeTimestamp + limit）

说明：消息返回中的 `toolsUsed/tokenUsage` 后端已从 DB JSON 字符串解析为对象/数组，前端可直接展示。

## 4. 配置面板（Config Panel）

后端提供配置 CRUD + 校验接口（正常模式也可用）：

- Schema：`GET /api/config/schema`（适合动态表单渲染/前端校验提示）
- 当前合并配置：`GET /api/config/current`
- 基础配置：`GET/POST /api/config/base`
- Override 配置：`GET/POST /api/config/override`
- 校验：`POST /api/config/validate`（支持 partial 校验）

注意：保存 override 后端会提示需要手动重启服务以使配置生效，前端建议在保存成功后明确提示用户。

## 5. 调试建议

- 先打 `/health` 验证后端是否启动。
- 遇到失败响应，统一把 `message/error` 打到控制台，便于快速定位。
