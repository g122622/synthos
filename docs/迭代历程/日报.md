# 基本思路

功能：
个人用户回顾自己关注的群聊
其实是半日报（定时任务，中午、晚上各推送过去半天的群聊消息）
还可以再来个周报、月报
不需要支持分享

内容：
基于已有的 AIDigestResult（话题摘要），挑选高价值话题汇总成日报。实现细节是：先去掉兴趣度为负数的话题，然后提取出标题喂给llm；除了标题外，也可以选择一些具体内容喂给llm
希望日报是unity的，即不需要按群组分类展示，平等对待这些信息
日报中需要包含数据统计（如话题总数、最活跃群组、最活跃时段等）
统计数据在日报中的呈现位置：在开头（先看统计，再看综述和话题）

UI：
web端展示（日报需要存储在数据库中，以便历史查阅，可追溯历史日报） + 邮件推送

---

# 实现状态: ✅ 已完成

## 新增/修改的文件清单

### common 模块
- `common/config/@types/GlobalConfig.ts` - 新增 `ReportConfigSchema` 配置
- `common/database/constants/InitialSQL.ts` - 新增 `createReportTableSQL` 建表语句
- `common/database/ReportDbAccessService.ts` - 新增日报数据库管理器
- `common/contracts/report/index.ts` - 新增日报类型定义
- `common/scheduler/@types/Tasks.ts` - 新增 `GenerateReport` 任务类型

### ai-model 模块
- `ai-model/src/tasks/GenerateReport.ts` - 新增日报生成任务
- `ai-model/src/context/prompts/ReportPromptStore.ts` - 新增日报 Prompt 模板
- `ai-model/src/index.ts` - 注册日报生成任务

### webui-backend 模块
- `webui-backend/src/services/EmailService.ts` - 新增邮件发送服务
- `webui-backend/src/services/ReportService.ts` - 新增日报业务服务
- `webui-backend/src/controllers/ReportController.ts` - 新增日报控制器
- `webui-backend/src/schemas/index.ts` - 新增日报参数校验 Schema
- `webui-backend/src/di/tokens.ts` - 新增日报相关 Token
- `webui-backend/src/di/container.ts` - 注册日报相关依赖
- `webui-backend/src/routers/apiRouter.ts` - 新增日报 API 路由
- `webui-backend/src/lifecycle/dbInitialization.ts` - 初始化 ReportDbAccessService
- `webui-backend/src/index.ts` - 注册 ReportDbAccessService
- `webui-backend/package.json` - 新增 nodemailer 依赖

### orchestrator 模块
- `orchestrator/src/index.ts` - 新增日报定时任务调度

### webui-frontend 模块
- `webui-frontend/src/api/reportApi.ts` - 新增日报 API 调用
- `webui-frontend/src/pages/reports/reports.tsx` - 新增日报页面
- `webui-frontend/src/pages/reports/components/ReportCard.tsx` - 新增日报卡片组件
- `webui-frontend/src/pages/reports/components/ReportDetailModal.tsx` - 新增日报详情弹窗
- `webui-frontend/src/App.tsx` - 新增日报路由
- `webui-frontend/src/config/site.ts` - 新增日报导航

---

# 细节

### 1. 功能定义
| 维度 | 说明 |
|------|------|
| **报告类型** | 半日报、周报、月报 |
| **定时触发** | 中午、晚上各推送一次半日报 |
| **内容来源** | 基于 `AIDigestResult`，过滤掉兴趣度 < 0 的话题 |
| **LLM处理** | 提取话题标题（及部分正文 detail字段）喂给 LLM 生成综述 |
| **内容风格** | Unity（统一展示，不按群组分类） |
| **统计数据** | 话题总数、最活跃群组、最活跃时段等 |

### 2. 技术实现
| 模块 | 实现方式 |
|------|----------|
| **存储** | 新增数据库表存储日报/周报/月报 |
| **调度** | 使用现有 Agenda 框架，新增定时任务 |
| **前端** | 新增"日报"页面，支持历史查阅 |
| **邮件** | 需要新增邮件发送基建（项目中暂无） |

---

## ❓ 需要进一步明确的问题

### 一、关于定时触发的时间点

1. **"中午"和"晚上"的具体时间是？**
   - 默认：中午 12:00、晚上 18:00
   - 但也是可配置的（在 GlobalConfig 中配置）

2. **半日报覆盖的时间范围按照"中午"和"晚上"的具体时间来分割**

### 二、关于 LLM 生成综述

3. **LLM 生成的内容格式是什么？**
   - 纯文本综述（如"今天群里主要讨论了 xxx，其中关于 yyy 的讨论较为激烈..."）

4. **喂给 LLM 的内容上限是多少？**
   - 如果某个时段有 100 个话题，只取 Top N
   - Top N 的排序依据是兴趣度评分
   - N 的值可配置

5. **LLM 调用失败时的兜底策略是什么？**
   - 重试 N 次后放弃（不生成综述，只展示原始话题列表）
   - N 可配置

如果某个时段没有任何话题（或过滤后为空），则生成一个"本时段暂无热门话题"的空日报，并将isEmpty置为true

### 三、关于数据统计

6. **"最活跃群组"的定义是什么？**
   话题数量最多的群

7. **"最活跃时段"的粒度是什么？**
   按小时（如 14:00-15:00）

### 四、关于邮件推送

8. **邮件推送的收件人是谁？**
   在配置文件中配置固定邮箱（数组）

9. **邮件内容和 Web 端展示的内容一致**

10. **邮件发送方式？**
    - 使用 SMTP（需配置邮箱账号密码）

邮件的标题格式：[Synthos 半日报] 2024-01-15 上午

邮件发送失败: 重试 N 次,记录日志(n可配置)

### 五、关于周报/月报

11. **周报/月报的触发时机是？**
    - 周报：默认每周一早上（可配置）
    - 月报：默认每月1号早上（可配置）

12. **周报/月报的生成逻辑是？**
    - 汇总该周期内的所有半日报 + 辅以独立查询该周期的原始话题数据重新生成

### 六、关于 Web 端展示

13. **日报页面的交互设计？**
    - 需要日历视图方便选择历史日期
    - 支持按周/月切换视图

14. **日报中的话题是否可点击跳转到详情？**
    - 类似现有的 `latest-topics` 页面中的 `TopicCard`

# 技术细节

## 日报存储的格式：

```ts
interface Report {
  reportId: string;                      // 主键
  type: 'half-daily' | 'weekly' | 'monthly';  // 报告类型
  timeStart: number;               // 统计周期开始时间 毫秒级时间戳
  timeEnd: number;                 // 统计周期结束时间 毫秒级时间戳

  isEmpty: boolean; // 没有任何话题（或过滤后为空）
  
  // LLM 生成的综述
  summary: string;                 // 综述文本
  summaryGeneratedAt: Date;        // 综述生成时间
  summaryStatus: 'success' | 'failed' | 'pending';  // 生成状态
  model: string; // 生成综述时的模型名
  
  // 统计数据
  statistics: {
    topicCount: number;            // 话题总数
    mostActiveGroups: string[];       // 最活跃群组（取三个）
    mostActiveHour: number;        // 最活跃时段（小时）
  };
  // 关联的话题 ID 列表（用于点击跳转）
  topicIds: string[];
  
  createdAt: number;
  updatedAt: number;
}
```
