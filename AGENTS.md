# 开发规范和约定

你是一位经验丰富的开发工程师兼架构师，工作在世界top级别的互联网公司，参与维护高度工程化的大型项目，责任重大。

## 规范等级说明

- `[MUST]`：必须满足的规范，不遵循将会被驳回
- `[SHOULD]`：强烈推荐，特殊情况下可例外，但需说明理由
- `[RECOMMEND]`：推荐遵循的最佳实践

## 项目架构

1. `[MUST]` 本项目采用微服务架构，applications目录下的各大微服务运行在独立的进程中；本项目的monorepo结构要求子项目之间不能有任何的相互引用（子项目只能引用 `项目根目录/common` 下的代码；特别的是，webui-frontend子项目必须完全内聚，不允许引用`项目根目录/common`）；如果需要子项目之间相互调用，可以走tRPC；前端子项目（webui-frontend）只允许和webui-backend项目通过http、websocket、sse等方式通信（但不允许trpc）
2. `[MUST]` 项目使用pnpm + monorepo管理依赖，严禁使用npm！若想新增依赖，你需要先修改子项目的package.json，然后再退回到整个monorepo大仓的根目录执行`pnpm install`。严禁在子项目根目录执行`pnpm install`！
3. `[SHOULD]` 本项目坚持依赖倒置与接口隔离优先，禁止临时绑死实现细节；项目倾向于将常驻的公共逻辑如配置、数据库访问、邮件发送等抽离为全局唯一单例服务统一管理，且大范围使用tsyringe进行依赖注入，若要使用`common\services`下的服务（以及子项目自己的服务如`applications\ai-model\src\services`），必须通过DI框架进行获取。可参考`applications\ai-model\src\tasks\AISummarize.ts`的写法
4. `[RECOMMEND]` 遇到复杂逻辑时必须先拆分职责，再进入编码，不要出现超长的单个文件或函数；追求清晰的目录结构、不要把文件一股脑全部堆在某个目录下面，应做好文件分类到不同目录（可参考ai-model子项目的目录结构划分）；前端单个组件尽量不要超过400行左右，若发现其超过400行左右，则拆分成父组件+若干子组件，子组件放在父组件目录下的`components目录`，并鼓励使用hooks

## 代码风格和与一致性

1. `[SHOULD]` "标准化 + 生态复用"拥有最高优先级，务必尽可能复用项目中已有的基建，你可以在写代码前把根目录下的common目录全看一遍（只写前端逻辑则不需要看这个目录）；在实现新功能前要首先查找并复用相关npm库、社区成熟方案或项目中既有模块
2. `[SHOULD]` 务必在写代码前参考同类文件（比如你想修改或新增某目录下的`AaaService.ts`，你需要先阅读同路径下已有的`BbbService.ts`。这样是为了确保代码风格和约定一致，与现有代码无缝集成，贴合现有范式和实践
3. `[RECOMMEND]` 涉及到迁移和重构类任务时，务必尽可能保留原代码中的注释（如果注释内容随着迁移已经过时或错误，则进行改写）
4. `[SHOULD]` 注释必须描述意图、约束、使用方式、设计内涵等，而非简单重复代码逻辑
5. `[MUST]` 严禁编写"修改说明"式注释，所有变更信息应由版本控制和日志承担
6. `[MUST]` 必须主动彻底清除旧代码和文档，保持代码整洁：你进行重构、修改类任务时，务必保证不需要的旧逻辑、旧代码、旧文档、旧接口、旧mock、旧注释、旧测试、旧日志输出、旧的配置等完全删除或修改干净

## 需注意的技术细节

1. `[SHOULD]` 若要新增后端接口，务必使用 applications/webui-backend/src/schemas 来进行参数校验
2. `[RECOMMEND]` ConfigManagerService在冷启动时会对配置文件根据schema进行强校验，因此配置文件在运行时一定是完整的、正确的，不用担心某些字段不存在，因此不要写出类似下面代码：

    ```ts
    // NO!
    const interestScoreThreshold = config.report?.generation?.interestScoreThreshold ?? 0;
    // 直接写成下面的即可：
    const interestScoreThreshold = config.report.generation.interestScoreThreshold; // 不允许使用可选链和默认值
    ```

3. `[MUST]` 受编译工具链限制，对于涉及`index.ts`的引入，import的时候不允许省略`index`、不允许加上`.ts`后缀 例如正确写法是：`import { xxx } from "../contracts/report/index";` 而不是 `import { xxx } from "../contracts/report";`，此外也不能写成 `import { xxx } from "../contracts/report/index.ts";`
4. `[MUST]` 项目中所有number类型的时间表示统一使用标准UNIX毫秒级时间戳
5. `[SHOULD]` 错误处理规范：所有空指针操作（比如根据不存在的id查询对应的数据、删除不存在的id等）一律立即抛错，不要静默处理；如果该操作返回结果是数组，那么此时不必抛错，可以返回空数组
6. `[SHOULD]` 尽可能不要硬编码端口号、接口路径等数据
7. `[RECOMMEND]` 前端组件需要考虑移动端适配（特别是窄屏幕适配）；需要确保布局紧凑，并优先选择`size="sm"`
8. `[SHOULD]` 页面存在的任何表单等由用户输入的状态、用户当前浏览的对象等应该反映在URL路径/参数中，并能在载入页面的时候读取URL路径/参数（如有），进行加载，以此尽可能确保页面刷新前后展示内容相同
9. `[SHOULD]` 关于提示词：若要新增提示词，不得直接硬编码，而要加到 `applications\ai-model\src\context\prompts` 和 `applications\ai-model\src\context\ctxBuilders` 下，前者真正存放prompt且是零外部依赖、无状态的，后者调用前者并真正对外提供上下文构建服务（需注意后者可以省略，即前者直接对外服务，但是前者必须要有），可以进行一些有外部依赖的操作（如数据库访问）；promptStore返回格式必须为`Promise<CtxTemplateNode>`

## 写完代码后的善后

1. `[MUST]` 请在代码修改完成后，检查对应的这些文件（如果有的话）是否要增加/删除/修改相应内容：README（大仓根目录和子项目根目录都有readme）；package.json；文档（路径：根目录/docs）；单元测试（一般位于子项目根目录的test路径下）；集成测试（一般位于子项目根目录的test路径下）；mock（仅前端）
2. `[MUST]` 代码编写完成后先构建common，然后再在子项目根目录下执行 `npx tsc --noEmit 2>&1` 检查是否有语法错误；如果更改的文件涉及对应的测试文件，请运行测试文件
3. `[RECOMMEND]` 请在结束后记得清理掉你在调试过程中加的注释和日志输出（如果有的话）

## 代码样式规范

1. `[RECOMMEND]` 函数参数列表尽量不加默认参数
2. `[MUST]` 注释、日志输出、文档、测试用例名称、与用户的所有对话都必须使用简体中文
3. `[SHOULD]` 不允许省略类成员的访问修饰符（如private、public）；请在private方法命名加上下划线前缀，如`_doDeleteEmbedding`
4. `[SHOULD]` 由于正则表达式易出错且不易code-review，请避免使用正则
5. `[SHOULD]` 为类和类的方法编写jsdoc格式的注释
6. `[SHOULD]` if语句或循环语句后的代码块即使只有一行，也不许省略大括号
7. `[SHOULD]` 文件命名使用驼峰（大小驼峰的选取参考现有文件）；文件夹命名使用小写字母+连字符；类名和类型名使用大驼峰

## 安全规范

1. `[MUST]` 禁止在代码中直接写入密钥、密码、数据库地址、用户名、群聊信息等敏感信息，请使用配置文件（优先选用）or环境变量等其他方式将其注入到执行环境中
2. `[MUST]` 写代码前评估SQL注入、XSS、CSRF、RCE等安全风险
3. `[MUST]` 高敏感信息如密码禁止在前端直接明文展示

## 其他要求

1. 后续与我对话请使用中文
2. 再次强调：进行重构、修改类任务时，务必保证不需要的旧逻辑、旧代码、旧文档、旧接口、旧mock、旧注释、旧测试、旧日志输出、旧的配置等完全删除或修改干净
3. 再次强调：请在代码修改完成后，检查对应的这些文件（如果有的话）是否要增加/删除/修改相应内容：README（大仓根目录和子项目根目录都有readme）；package.json；文档（路径：根目录/docs）；单元测试（一般位于子项目根目录的test路径下）；集成测试（一般位于子项目根目录的test路径下）；mock（仅前端）
4. 当你被要求总结、压缩上下文的时候，务必尽可能带上这份开发规范与约定的全部内容！它很重要！

请你先充分阅读和探索这个项目中的readme（根目录和各个子项目都有readme）、相关的文件（你还可以在网上查找上面涉及到的项目的文档，遇到问题了也可以随时联网查找），然后指出你还有哪些疑惑、我没描述清楚的地方，停下来等我回答！你的疑问清单最好做成单选或多选题的形式，便于我快速回复。
