import { CtxTemplateNode } from "../../template/CtxTemplate";
import { CtxMiddleware } from "../container/container";
import { ContentUtils } from "../../template/ContentUtils";

// 第一个key是关键词，第二个是相关解释
export type KnowledgeBase = Map<string[], string[]>;

// 注入背景知识
export const addBackgroundKnowledgeMiddleware: CtxMiddleware = rootNode => {
    const fullText = rootNode.serializeToString().toLowerCase();

    const knowledgeBase: KnowledgeBase = new Map([
        // 通用保研/升学相关术语
        [
            ["BG"],
            [
                "background，即背景，可能是自己的排名、竞赛、科研、本科学校水平等情况；",
                "指公司组织架构中的business group，即事业群"
            ]
        ],
        [["RK", "rank"], ["指自己的排名"]],
        [
            ["com", "committee"],
            [
                "指学校的招生办。在行政上，com拥有依照文件精神招生的权力，教授并无权力直接决定学生的录取。弱com即保研学校的招生办对生源的要求较低，考察方式比较灵活，主要由老师/lab来完成学生的挑选；而强com则要求学生必须符合学校的招生标准，考察方式严格，一般由招生办先完成第一步的考评（如rank筛、机试筛选等）来先一步完成学生的初筛，再由老师做进一步的考察。换句话说，强com和弱com其实本质上是一样的，都是为了保证学生的合格性，只不过决定学生是否有被录取资格的话语权是被招生办还是老师掌握的区别。对于弱com而言，学生的某方面专业素养可能更加被重视，和老师取得稳定的联系比较重要；对于强com而言，招生办可能更加注重学生的综合素养和专业基础，这些因素会反过来影响学生的准备策略。"
            ]
        ],
        [
            ["bar"],
            [
                "学校筛选学生进入面试的最低要求。因报名人数众多，不可能让每个学生都进去面试，所以需要 bar。近年来，bar有变成纯学校+排名筛选的倾向"
            ]
        ],
        [["WL", "wait list", "waiting list"], ["就是候补，如果前面的人选择其他学校，那么候补就有机会上位"]],
        [
            ["OQ", "over qualified"],
            [
                "当某同学的实力远超学校的 bar 时，学校仍有可能拒绝该学生的申请。这种现象叫 oq，因为该生来这所学校的可能性太低，学校没必要浪费资源面试这位同学"
            ]
        ],
        [
            ["RA", "research assistant"],
            [
                "科研助理，也就是进组打工。部分老师（常见于top高校）会更倾向于接收提前在课题组打工的学生，但此项并非必须，作为学生要考虑好自己的时间安排与课业平衡。"
            ]
        ],
        [
            ["AP", "assistant professor"],
            [
                "助理教授，是尚未通过终身教职（tenure）评审的初级阶段教职。虽然名称中有“助理”二字，但助理教授并不“助理”，相反，许多 ap 是年轻有为、科研能力突出的优秀学者。只是因为入职时间尚短，职称上处于起步阶段。"
            ]
        ],
        [["青教", "青椒"], ["青年教师，相对年轻，具备招生资格的高校老师"]],

        // 学科代码
        [["0812"], ["学科代码：计算机科学与技术（学硕）"]],
        [["0835"], ["学科代码：软件工程（学硕）"]],
        [["0839"], ["学科代码：网络空间安全（学硕）"]],
        [["085400"], ["学科代码：电子信息类（专硕）"]],
        [["085404"], ["学科代码：计算机技术（0812 对应的专硕）"]],
        [["085405"], ["学科代码：软件工程（0835 对应的专硕）"]],
        [["085410"], ["学科代码：人工智能（专硕）"]],
        [["085412"], ["学科代码：网络与信息安全（0839 对应的专硕）"]],

        // 联系导师相关
        [["陶瓷", "套磁"], ["指向老师发邮件等方式取得私人联系，打好关系"]],
        [
            ["羊导", "颠导", "强导", "弱导"],
            [
                "指导老师的级别，强导老师的指导力度更强（往往更加push），弱导老师的指导力度更弱（未必不push），颠导（任务强度令人不适，对待学生态度不友善），羊导（任务轻松，对待学生很热情，但往往指导很少）"
            ]
        ],

        // 公司组织与岗位相关
        [["HC", "Headcount"], ["一家公司的招聘人头数"]],
        [["BU", "Business Unit"], ["通常指挂靠在BG下细分的业务单元，通常指业务线或者产品线"]],
        [["OD", "Outsourcing Dispatch"], ["外包派遣，只有研发类岗位，比如华为OD"]],
        [["OT", "overtime"], ["加班"]],

        // 岗位黑话
        [["base"], ["薪水：例如 15k*16 base代表15k；", "工作地点：比如这个base是在北京还是在上海"]],
        [
            ["JD", "job description"],
            ["职位描述，包含岗位职责和要求，例如后端研发需熟悉 Java/C++/Golang 等语言及数据结构与算法"]
        ],
        [["HR", "Human Resource"], ["人力资源，负责招聘、选拔、使用、培养、考核员工等，俗称“招打工人的人”"]],
        [
            ["RD", "Research and Development engineer"],
            ["研发工程师，如前端/后端开发工程师（C++、Java、Golang等）"]
        ],
        [["QA", "Quality Assurance"], ["品质保证，即测试工程师，负责产品质量保障"]],
        [["PM", "Product Manager", "Project Manager"], ["产品经理或项目经理，负责需求分析、产品规划、协调研发等"]],
        [["PR", "Public Relationship"], ["公共关系，即公关，工作包括舆情监测、媒体关系、文案输出、活动策划等"]],
        [["PD", "Product Designer"], ["产品设计或产品负责人，常与程序员协作定义功能需求"]],
        [["ld", "leader", "+1", "+2"], ["领导、团队负责人，+1表示直接上级，+2表示上上级"]],

        // 求职与薪资黑话
        [
            ["八股文"],
            ["概念性题目，如操作系统中进程与线程区别、三次握手四次挥手等，答案固定，类似科举八股文，常需背诵"]
        ],
        [
            ["OC", "意向书"],
            [
                "秋招中通过面试后获得的口头offer，无具体薪资，表示“打算要你了”，通常7-10月发放；正式带薪offer多在10月中下旬发放"
            ]
        ],
        [["开奖"], ["互联网公司通过电话或邮件告知offer薪资的行为，称为“开奖”"]],
        [["泡池子"], ["迟迟未发offer也无结果，候选人被留在人才池中，可能被后续捞起，也可能石沉大海"]],
        [["保温"], ["HR或主管在发offer前定期联系候选人，了解其意向或已有offer情况，防止流失"]],
        [["A", "argue"], ["对开薪不满意时与HR协商提薪，建议在手握更高offer时进行，成功率更高"]],
        [["总包"], ["年薪总收入，含基础工资+绩效+年终奖+补贴+奖金+福利；注意区分base与其他浮动部分"]],
        [["烂白菜"], ["校招offer中最低一档薪资待遇"]],
        [["白菜"], ["校招生中60%-70%拿到的标准offer薪资"]],
        [["大白菜"], ["比白菜稍高一档的薪资"]],
        [["小SP"], ["大佬拿到的偏低档offer，但仍高于大白菜"]],
        [["SP"], ["顶尖校招生才能获得的高薪offer，如阿里星、快Star、蓝剑计划等项目的入选者"]],
        [["SSP+"], ["极少数“神仙级”选手获得的顶级offer，极为罕见"]],

        // 大厂背书
        [["大厂背书"], ["指在顶尖公司实习或工作经历带来的能力认证效应，在跳槽时显著提升竞争力和认可度"]],

        // 互联网公司外号
        [["鹅厂"], ["腾讯"]],
        [["猪场"], ["网易"]],
        [["狗厂", "兄弟厂"], ["京东"]],
        [["菊厂"], ["华为"]],
        [["动物园", "猫厂", "福报厂"], ["阿里巴巴"]],
        [["开水厂"], ["美团"]],
        [["宇宙厂"], ["字节跳动"]],
        [["体面厂"], ["海康威视"]],
        [["发点厂"], ["B站（哔哩哔哩）"]],
        [["狐厂"], ["搜狐"]],
        [["渣厂"], ["新浪"]],
        [["蓝厂"], ["VIVO"]],
        [["鸟厂"], ["迅雷"]],
        [["真香厂"], ["拼多多"]],
        [["桔厂"], ["滴滴"]],
        [["数字厂"], ["360"]],
        [["wifi厂"], ["爱奇艺"]],
        [["猴厂"], ["小米"]],
        [["老铁厂"], ["快手"]]
    ]);
    const results = [] as string[];

    // 遍历知识库，找到匹配的关键词
    for (const [keywords, explanations] of knowledgeBase) {
        for (const keyword of keywords) {
            if (fullText.includes(keyword.toLowerCase())) {
                results.push(`关键词：${keywords.toString()}, 解释：${explanations.join("")}`);
                break;
            }
        }
    }

    if (results.length > 0) {
        rootNode.insertChildNodeToFront(
            new CtxTemplateNode()
                .setTitle("背景知识(由系统仅根据关键词自动匹配得出，因此可能不准确)")
                .setContentText(ContentUtils.unorderedList(results))
        );
    }
    return rootNode;
};
